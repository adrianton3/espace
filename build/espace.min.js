/*! espace 2014-09-28; Copyright 2014 Adrian Toncean; released under the MIT license */
!function(){"use strict";function a(a,b){function c(a,b){if("("===b.token.type){if("("!==a.token.type)return!1;if(b.rest){if(a.children.length<b.rest.before+1+b.rest.after)return!1}else if(a.children.length!==b.children.length)return!1;if("identifier"!==a.children[0].token.type||a.children[0].token.value!==b.children[0].token.value)return!1;if(b.rest){for(var e=1;e<=b.rest.before;e++)if(!c(a.children[e],b.children[e]))return!1;d[b.rest.name]=a.children.slice(1+b.rest.before,a.children.length-b.rest.after);for(var e=0;e<b.rest.after;e++)if(!c(a.children[a.children.length-b.rest.after+e],b.children[e+1+1+b.rest.before]))return!1}else for(var e=1;e<b.children.length;e++)if(!c(a.children[e],b.children[e]))return!1;return!0}return d[b.token.value]=a,!0}var d={};return c(a,b,d)?d:null}function b(a){var c={token:{type:a.token.type}};return a.token.hasOwnProperty("value")&&(c.token.value=a.token.value),"("===a.token.type&&(c.children=a.children.map(function(a){return b(a)})),c}function c(a,b,c){var d=[b,1].concat(c);return Array.prototype.splice.apply(a,d),a}function d(a){return a.length>1&&"_"===a[0]}function e(a,b,e){function f(a){if(a.children.length){var h=a.children[0];d(h.token.value)&&(g[h.token.value]||("undefined"!=typeof e[h.token.value]?e[h.token.value]++:e[h.token.value]=0,g[h.token.value]=h.token.value+"_"+e[h.token.value]),h.token.value=g[h.token.value])}for(var i=1;i<a.children.length;i++){var h=a.children[i];if("identifier"===h.token.type){var j=b[h.token.value];Array.isArray(j)?(c(a.children,i,j),i+=j.length-1):j?a.children[i]=j:d(h.token.value)&&(g[h.token.value]||("undefined"!=typeof e[h.token.value]?e[h.token.value]++:e[h.token.value]=0,g[h.token.value]=h.token.value+"_"+e[h.token.value]),h.token.value=g[h.token.value])}else"("===h.token.type&&f(h)}}var g={};if("identifier"===a.token.type){var h=b[a.token.value];h&&(a.token=h.token,"("===h.token.type&&(a.children=h.children))}else"("===a.token.type&&f(a)}function f(a){return a.length>3&&"..."===a.substr(a.length-3)}function g(a){function b(a){if("("===a.token.type)for(var c=1;c<a.children.length;c++){var d=a.children[c].token;"identifier"===d.type&&f(d.value)?a.rest={before:c-1,after:a.children.length-c-1,name:d.value}:b(a.children[c])}}return b(a),a}function h(a){function b(a){if(a.children.length>0&&"identifier"!==a.children[0].token.type)throw new Error("Tokens of type "+a.children[0].token.type+" are not allowed in patterns");for(var e=!1,g=1;g<a.children.length;g++){var h=a.children[g];if("identifier"===h.token.type){if(d(h.token.value))throw new Error("Pattern can not contain variables prefixed by '_'");if(c[h.token.value])throw new Error('Variable "'+h.token.value+'" already used in pattern');if(c[h.token.value]=!0,f(h.token.value)){if(e)throw new Error("Pattern can contain at most one rest variable on a level");e=!0}}else{if("("!==h.token.type)throw new Error("Tokens of type "+h.token.type+" are not allowed in patterns");b(h)}}}var c={};if("("!==a.token.type)throw new Error("Pattern must not be an atom");b(a)}var i={};i.extract=a,i.deepClone=b,i.inject=e,i.processForRest=g,i.validatePattern=h,i.expand=function(c,d,f,h){function i(c){var g=a(c,d);if(g){var j=b(f);e(j,g,h),c.token=j.token,c.children=j.children}"("===c.token.type&&c.children.forEach(i)}g(d),h=h||{},i(c)},window.espace=window.espace||{},window.espace.Expander=i}(),function(){"use strict";function a(a,b){var c=new Error(b);throw c.coords=a.coords,c}var b={};b.parse=function(b){if(!b.length)return null;var c,d=[],e=null,f=b[0];if("("===f.type)e={token:f,children:[]},c=e,d.push(e);else{if(")"!==f.type)return b.length>1&&a(f,"Unexpected token"),c={token:f};a(f,"Cannot start with )")}for(var g=1;g<b.length;g++)if(f=b[g],e||a(f,"Unexpected token"),"("===f.type){var h={token:f,children:[]};e.children.push(h),e=h,d.push(e)}else")"===f.type?(d.pop(),e=d[d.length-1]):e.children.push({token:f});return d.length&&a(f,"Missing )"),c},window.espace=window.espace||{},window.espace.Parser=b}(),function(){"use strict";var a={};a.serialize=function(b){if(!b)return"";switch(b.token.type){case"string":return'"'+b.token.value+'"';case"number":return""+b.token.value;case"identifier":return b.token.value;case"(":return"("+b.children.map(function(b){return a.serialize(b)}).join(" ")+")"}},window.espace=window.espace||{},window.espace.Serializer=a}(),function(){"use strict";function a(a){this.string=a,this.pointer=0,this.marker=0,this.line=1,this.column=1}a.prototype.advance=function(){"\n"===this.current()?(this.line++,this.column=1):this.column++,this.pointer++},a.prototype.setMarker=function(a){a=a||0,this.marker=this.pointer+a},a.prototype.current=function(){return this.string.charAt(this.pointer)},a.prototype.next=function(){return this.string.charAt(this.pointer+1)},a.prototype.hasNext=function(){return this.pointer<this.string.length},a.prototype.getMarked=function(a){return a=a||0,this.string.substring(this.marker,this.pointer+a)},a.prototype.getCoords=function(){return{line:this.line,column:this.column}},window.espace=window.espace||{},window.espace.IterableString=a}(),function(){"use strict";function a(a,b){var c=new Error(b);throw c.coords=a,c}function b(b){function c(b){var c=[];for(b.advance();;){if("\\"===b.current())b.advance(),o[b.current()]&&c.push(o[b.current()]);else{if("'"===b.current())return b.advance(),j("string",c.join(""),b.getCoords());"\n"!==b.current()&&b.hasNext()?c.push(b.current()):a(b.getCoords(),"String not properly ended")}b.advance()}}function d(b){var c=[];for(b.advance();;){if("\\"===b.current())b.advance(),o[b.current()]&&c.push(o[b.current()]);else{if('"'===b.current())return b.advance(),j("string",c.join(""),b.getCoords());"\n"!==b.current()&&b.hasNext()?c.push(b.current()):a(b.getCoords(),"String not properly ended")}b.advance()}}function e(b){b.setMarker();for(var c=b.current();c>="0"&&"9">=c;)b.advance(),c=b.current();if("."==b.current()){b.advance();for(var c=b.current();c>="0"&&"9">=c;)b.advance(),c=b.current()}return-1===") \n	".indexOf(b.current())&&a(b.getCoords(),"Unexpected character '"+b.current()+"' after '"+b.getMarked()+"'"),j("number",+b.getMarked(),b.getCoords())}function f(b){for(b.setMarker(2),b.advance(),b.advance();;){if("-"===b.current()&&";"===b.next())return b.advance(),b.advance(),j("comment",b.getMarked(-2),b.getCoords());b.hasNext()?b.advance():a(b.getCoords(),"Multiline comment not properly terminated")}}function g(a){for(a.setMarker(1),a.advance();;){if("\n"===a.current()||!a.hasNext())return a.advance(),j("comment",a.getMarked(),a.getCoords());a.advance()}}function h(a){a.setMarker();for(var b=a.current();b>" "&&"~">=b&&"("!=b&&")"!=b;)a.advance(),b=a.current();return j("identifier",a.getMarked(),a.getCoords())}function i(a){var b=a.current();return a.advance(),j("whitespace",b,a.getCoords())}b=b||{};var j,k,l=!!b.whitespace,m=!!b.comments,n=!!b.coords;n?(j=function(a,b,c){return{type:a,value:b,coords:c}},k=function(a,b){return{type:a,coords:b}}):(j=function(a,b){return{type:a,value:b}},k=function(a){return{type:a}});var o={"\\":"\\",n:"\n",t:"	","'":"'",'"':'"'};return function(a){for(var b=new espace.IterableString(a),j=[];b.hasNext();){var n=b.current();if("'"===n)j.push(c(b));else if('"'===n)j.push(d(b));else if(";"===n){var o=b.next();if("-"===o){var p=f(b);m&&j.push(p)}else{var p=g(b);m&&j.push(p)}}else if(n>="0"&&"9">=n)j.push(e(b));else if("("===n)j.push(k("(",b.getCoords())),b.advance();else if(")"===n)j.push(k(")",b.getCoords())),b.advance();else if(n>" "&&"~">=n)j.push(h(b));else{var p=i(b);l&&j.push(p)}}return j}}window.espace=window.espace||{},window.espace.Tokenizer=b}();