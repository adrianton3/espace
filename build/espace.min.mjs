/*! espace by Adrian Toncean released under the MIT license */
function k(e){this.string=e;this.pointer=0;this.marker=0;this.line=1;this.column=1}k.prototype.advance=function(){if(this.current()==="\n"){this.line++;this.column=1}else{this.column++}this.pointer++};k.prototype.setMarker=function(e=0){this.marker=this.pointer+e};k.prototype.current=function(){return this.string.charAt(this.pointer)};k.prototype.next=function(){return this.string.charAt(this.pointer+1)};k.prototype.hasNext=function(){return this.pointer<this.string.length};k.prototype.getMarked=function(e=0){return this.string.substring(this.marker,this.pointer+e)};k.prototype.getCoords=function(){return{line:this.line,column:this.column}};function r(e,t){const n=new Error(t);n.coords=e;throw n}function e(i,e={}){const o=!!e.whitespace;const l=!!e.comments;const t=!!e.coords;const c=e.prefixes||{};const s=t?(e,t,n)=>({type:e,value:t,coords:n}):(e,t)=>({type:e,value:t});const n={"\\":"\\",n:"\n",t:"\t",'"':'"'};function a(e){const t=[];e.advance();while(true){if(e.current()==="\\"){e.advance();if(n[e.current()]){t.push(n[e.current()])}}else if(e.current()==='"'){e.advance();return s("string",t.join(""),e.getCoords())}else if(e.current()==="\n"||!e.hasNext()){r(e.getCoords(),"String not properly ended")}else{t.push(e.current())}e.advance()}}function u(t){t.setMarker();let e=t.current();while(e>="0"&&e<="9"){t.advance();e=t.current()}if(t.current()==="."){t.advance();let e=t.current();while(e>="0"&&e<="9"){t.advance();e=t.current()}}if(!")]} \n\t".includes(t.current())){r(t.getCoords(),`Unexpected character '${t.current()}' after '${t.getMarked()}'`)}return s("number",Number(t.getMarked()),t.getCoords())}function f(e){e.setMarker(2);e.advance();e.advance();while(true){if(e.current()==="-"&&e.next()===";"){e.advance();e.advance();return s("comment",e.getMarked(-2),e.getCoords())}else if(e.hasNext()){e.advance()}else{r(e.getCoords(),"Multiline comment not properly terminated")}}}function h(e){e.setMarker(1);e.advance();while(true){if(e.current()==="\n"||!e.hasNext()){e.advance();return s("comment",e.getMarked(),e.getCoords())}else{e.advance()}}}function d(e){e.setMarker();let t=e.current();while(t>" "&&t<="~"&&t!=="("&&t!==")"&&t!=="["&&t!=="]"&&t!=="{"&&t!=="}"){e.advance();t=e.current()}return s("identifier",e.getMarked(),e.getCoords())}function p(e){const t=e.current();e.advance();return s("whitespace",t,e.getCoords())}return(()=>{const e=new k(i);const t=[];while(e.hasNext()){const n=e.current();if(n==='"'){t.push(a(e))}else if(n===";"){if(e.next()==="-"){const r=f(e);if(l){t.push(r)}}else{const r=h(e);if(l){t.push(r)}}}else if(n>="0"&&n<="9"){t.push(u(e))}else if(n==="("||n==="["||n==="{"){t.push(s("open",n,e.getCoords()));e.advance()}else if(n===")"||n==="]"||n==="}"){t.push(s("closed",n,e.getCoords()));e.advance()}else if(c.hasOwnProperty(n)){t.push(s("prefix",c[n],e.getCoords()));e.advance()}else if(n>" "&&n<="~"){t.push(d(e))}else{const r=p(e);if(o){t.push(r)}}}return t})()}function l(e,t){const n=new Error(t);n.coords=e.coords;throw n}function c(e){return{type:"list",token:e,children:[]}}function s(e,t){return{type:"list",token:e,children:[{type:"atom",token:{type:"identifier",value:e.value}},t]}}function a(e){return e==="("?")":e==="["?"]":"}"}function t(r){let i=0;function o(){const e=r[i];i++;if(e.type==="open"){const t=c(e);const n=a(e.value);while(true){if(i>=r.length){l(r[i-1],`Expected matching '${n}' before end of input`)}if(r[i].type==="closed"){if(r[i].value===n){i++;break}else{l(r[i],`Expected matching '${a(e.value)}'`)}}t.children.push(o())}return t}if(e.type==="prefix"){if(i>=r.length){l(r[i-1],`Unexpected end of input`)}return s(e,o())}return{type:"atom",token:e}}const e=[];while(i<r.length){const t=r[i];if(t.type==="closed"){l(t,`Unexpected '${t.value}'`)}e.push(o())}return e}function n(e){if(e instanceof Array){return e.map(n).join(" ")}if(e.type==="list"){if(e.token.type==="prefix"){return`${e.token.value}${n(e.children[0])}`}else{const t=e.children.map(n).join(" ");return e.token.value==="("?`(${t})`:e.token.value==="["?`[${t}]`:`{${t}}`}}switch(e.token.type){case"string":return`"${e.token.value}"`;case"number":return String(e.token.value);case"identifier":return e.token.value}}function u(e,t){const r={};function i(t,n){if(n.type==="list"){if(t.type!=="list"||t.token.value!==n.token.value){return false}if(n.rest){if(t.children.length<n.rest.before+1+n.rest.after){return false}}else{if(t.children.length!==n.children.length){return false}}if(t.children[0].token.type!=="identifier"||t.children[0].token.value!==n.children[0].token.value){return false}if(n.rest){for(let e=1;e<=n.rest.before;e++){if(!i(t.children[e],n.children[e])){return false}}r[n.rest.name]=t.children.slice(1+n.rest.before,t.children.length-n.rest.after);for(let e=0;e<n.rest.after;e++){if(!i(t.children[t.children.length-n.rest.after+e],n.children[e+1+1+n.rest.before])){return false}}}else{for(let e=1;e<n.children.length;e++){if(!i(t.children[e],n.children[e])){return false}}}return true}else{r[n.token.value]=t;return true}}return i(e,t)?r:null}function f(e){const t={type:e.type,token:{type:e.token.type,value:e.token.value}};if(e.type==="list"){t.children=e.children.map(f)}return t}function h(e){return e.length>1&&e[0]==="_"}function d(e,i,o){const l={};function c(t){if(t.children.length>0){const n=t.children[0];if(h(n.token.value)){if(!l[n.token.value]){if(typeof o[n.token.value]!=="undefined"){o[n.token.value]++}else{o[n.token.value]=0}l[n.token.value]=`${n.token.value}_${o[n.token.value]}`}n.token.value=l[n.token.value]}}for(let e=1;e<t.children.length;e++){const n=t.children[e];if(n.token.type==="identifier"){const r=i[n.token.value];if(Array.isArray(r)){t.children.splice(e,1,...r);e+=r.length-1}else if(r){t.children[e]=r}else if(h(n.token.value)){if(!l[n.token.value]){if(typeof o[n.token.value]!=="undefined"){o[n.token.value]++}else{o[n.token.value]=0}l[n.token.value]=n.token.value+"_"+o[n.token.value]}n.token.value=l[n.token.value]}}else if(n.type==="list"){c(n)}}}if(e.token.type==="identifier"){const t=i[e.token.value];if(t){e.token=t.token;if(t.type==="list"){e.children=t.children}}}else if(e.type==="list"){c(e)}}function p(e){return e.length>3&&e.slice(-3)==="..."}function v(e){function r(t){if(t.type!=="list"){return}for(let e=1;e<t.children.length;e++){const{token:n}=t.children[e];if(n.type==="identifier"&&p(n.value)){t.rest={before:e-1,after:t.children.length-e-1,name:n.value}}else{r(t.children[e])}}}r(e)}function i(e,t){const i=new Set;const o=new Set;function l(t){if(t.children.length>0&&t.children[0].token.type!=="identifier"){throw new Error(`Tokens of type ${t.children[0].token.type} are not allowed in patterns`)}let n=false;for(let e=1;e<t.children.length;e++){const r=t.children[e];if(r.token.type==="identifier"){if(h(r.token.value)){throw new Error("Pattern can not contain variables prefixed by '_'")}if(i.has(r.token.value)){throw new Error(`Variable "${r.token.value}" already used in pattern`)}else{i.add(r.token.value)}if(p(r.token.value)){if(n){throw new Error("Pattern can contain at most one rest variable on a level")}n=true;o.add(r.token.value)}}else if(r.type==="list"){l(r)}else{throw new Error(`Tokens of type ${r.token.type} are not allowed in patterns`)}}}function n(t){if(t.type==="atom"){if(t.token.type==="identifier"&&p(t.token.value)&&!o.has(t.token.value)){throw new Error(`Rest variable '${t.token.value}' is not present in pattern`)}return}for(let e=0;e<t.children.length;e++){n(t.children[e])}}if(e.type==="list"){l(e)}else{throw new Error("Pattern can not be an atom")}n(t)}function o(e,r,i,o={}){v(r);function l(e){const t=u(e,r);if(t){const n=f(i);d(n,t,o);e.token=n.token;e.children=n.children}if(e.type==="list"){e.children.forEach(l)}}l(e)}export{o as expand,t as parse,n as serialize,e as tokenize,i as validateRule};