/*! espace by Adrian Toncean released under the MIT license */
function g(e){this.string=e;this.pointer=0;this.marker=0;this.line=1;this.column=1}g.prototype.advance=function(){if(this.getCurrent()==="\n"){this.line++;this.column=1}else{this.column++}this.pointer++};g.prototype.setMarker=function(e=0){this.marker=this.pointer+e};g.prototype.hasCurrent=function(){return this.pointer<this.string.length};g.prototype.getCurrent=function(){return this.string.charAt(this.pointer)};g.prototype.hasNext=function(){return this.pointer<this.string.length-1};g.prototype.getNext=function(){return this.string.charAt(this.pointer+1)};g.prototype.hasNextNext=function(){return this.pointer<this.string.length-2};g.prototype.getNextNext=function(){return this.string.charAt(this.pointer+2)};g.prototype.getMarked=function(e=0){return this.string.substring(this.marker,this.pointer+e)};g.prototype.getCoords=function(){return{line:this.line,column:this.column}};function v(e,t){const n=new Error(t);n.coords=e;throw n}function e(o,e){const t=e?.coords===true;const u=e?.prefixes!=null?new Map(Object.entries(e.prefixes)):new Map;const s=t?(e,t,n)=>({type:e,value:t,coords:n}):(e,t)=>({type:e,value:t});const n={"\\":"\\",n:"\n",t:"\t",'"':'"'};function a(e){const t=[];e.advance();while(true){if(e.getCurrent()==="\\"){e.advance();if(n[e.getCurrent()]){t.push(n[e.getCurrent()])}}else if(e.getCurrent()==='"'){e.advance();return s("string",t.join(""),e.getCoords())}else if(e.getCurrent()==="\n"||!e.hasNext()){v(e.getCoords(),"String not terminated")}else{t.push(e.getCurrent())}e.advance()}}function i(e){return e==="0"||e==="1"}function l(e){return e>="0"&&e<="9"}function c(e){return l(e)||e>="A"&&e<="F"||e>="a"&&e<="f"}function f(t){t.setMarker();let e=false;if(t.getCurrent()==="-"){t.advance();e=true}if(t.getCurrent()==="0"&&t.getNext()==="b"){t.advance();t.advance();if(!t.hasCurrent()){v(t.getCoords(),"Number not terminated")}const n=t.getCurrent();if(!i(n)){v(t.getCoords(),`Unexpected character '${t.getCurrent()}'`)}t.setMarker();t.advance();while(true){if(!t.hasCurrent()){const r=parseInt(t.getMarked(),2);return s("number",r===0?0:e?-r:r,t.getCoords())}const n=t.getCurrent();if(n!=="0"&&n!=="1"){if(!")]} \n\t;".includes(n)){v(t.getCoords(),`Unexpected character '${t.getCurrent()}'`)}const r=parseInt(t.getMarked(),2);return s("number",r===0?0:e?-r:r,t.getCoords())}t.advance()}}else if(t.getCurrent()==="0"&&t.getNext()==="x"){t.advance();t.advance();if(!t.hasCurrent()){v(t.getCoords(),"Number not terminated")}const n=t.getCurrent();if(!c(n)){v(t.getCoords(),`Unexpected character '${t.getCurrent()}'`)}t.setMarker();t.advance();while(true){if(!t.hasCurrent()){const r=parseInt(t.getMarked(),16);return s("number",r===0?0:e?-r:r,t.getCoords())}const n=t.getCurrent();if(!c(n)){if(!")]} \n\t;".includes(n)){v(t.getCoords(),`Unexpected character '${t.getCurrent()}'`)}const r=parseInt(t.getMarked(),16);return s("number",r===0?0:e?-r:r,t.getCoords())}t.advance()}}else{let e=t.getCurrent();while(l(e)){t.advance();e=t.getCurrent()}if(t.getCurrent()==="."){t.advance();let e=t.getCurrent();while(l(e)){t.advance();e=t.getCurrent()}}}if(!")]} \n\t;".includes(t.getCurrent())){v(t.getCoords(),`Unexpected character '${t.getCurrent()}'`)}return s("number",Number(t.getMarked()),t.getCoords())}function h(e){e.advance();e.advance();while(e.hasCurrent()){if(e.getCurrent()==="-"){if(!e.hasNext()){v(e.getCoords(),"Multiline comment not terminated")}if(e.getNext()===";"){e.advance();e.advance();return}}e.advance()}v(e.getCoords(),"Multiline comment not terminated")}function d(e){e.advance();while(e.hasCurrent()){if(e.getCurrent()==="\n"){e.advance();return}else{e.advance()}}}function p(e){e.setMarker();while(true){if(!e.hasCurrent()){return s("identifier",e.getMarked(),e.getCoords())}const t=e.getCurrent();if(t<=" "||t>"~"||t==="("||t===")"||t==="["||t==="]"||t==="{"||t==="}"||t===";"){return s("identifier",e.getMarked(),e.getCoords())}e.advance()}}return(()=>{const e=new g(o);const t=[];while(e.hasCurrent()){const n=e.getCurrent();if(n==='"'){t.push(a(e));continue}if(n===";"){if(e.getNext()==="-"){h(e)}else{d(e)}continue}if(n==="("||n==="["||n==="{"){t.push(s("open",n,e.getCoords()));e.advance();continue}if(n===")"||n==="]"||n==="}"){t.push(s("closed",n,e.getCoords()));e.advance();continue}if(n==="-"){if(!e.hasNext()){t.push(s("identifier","-",e.getCoords()));return t}const r=e.getNext();if(l(r)){t.push(f(e));continue}if(r==="."){if(!e.hasNextNext()){t.push(s("identifier","-.",e.getCoords()));return t}const i=e.getNextNext();if(l(i)){t.push(f(e));continue}}t.push(p(e));continue}if(n==="."){if(!e.hasNext()){t.push(s("identifier",".",e.getCoords()));return t}const r=e.getNext();if(l(r)){t.push(f(e));continue}t.push(p(e));continue}if(l(n)){t.push(f(e));continue}if(u.has(n)){t.push(s("prefix",u.get(n),e.getCoords()));e.advance();continue}if(n>" "&&n<="~"){t.push(p(e));continue}e.advance()}return t})()}function u(e,t){const n=new Error(t);n.coords=e.coords;throw n}function s(e){return{type:"list",token:e,children:[]}}function a(e,t){return{type:"list",token:e,children:[{type:"atom",token:{type:"identifier",value:e.value}},t]}}function l(e){return e==="("?")":e==="["?"]":"}"}function t(r){let i=0;function o(){const e=r[i];i++;if(e.type==="open"){const t=s(e);const n=l(e.value);while(true){if(i>=r.length){u(r[i-1],`Expected matching '${n}' before end of input`)}if(r[i].type==="closed"){if(r[i].value===n){i++;break}else{u(r[i],`Expected matching '${l(e.value)}'`)}}t.children.push(o())}return t}if(e.type==="prefix"){if(i>=r.length){u(r[i-1],`Unexpected end of input`)}return a(e,o())}return{type:"atom",token:e}}const e=[];while(i<r.length){const t=r[i];if(t.type==="closed"){u(t,`Unexpected '${t.value}'`)}e.push(o())}return e}function n(e){if(e instanceof Array){return e.map(n).join(" ")}if(e.type==="list"){if(e.token.type==="prefix"){return`${e.token.value}${n(e.children[0])}`}else{const t=e.children.map(n).join(" ");return e.token.value==="("?`(${t})`:e.token.value==="["?`[${t}]`:`{${t}}`}}switch(e.token.type){case"string":return`"${e.token.value}"`;case"number":return String(e.token.value);case"identifier":return e.token.value}}function c(e,t){const r={};function i(t,n){if(n.type==="list"){if(t.type!=="list"||t.token.value!==n.token.value){return false}if(n.rest){if(t.children.length<n.rest.before+1+n.rest.after){return false}}else{if(t.children.length!==n.children.length){return false}}if(t.children[0].token.type!=="identifier"||t.children[0].token.value!==n.children[0].token.value){return false}if(n.rest){for(let e=1;e<=n.rest.before;e++){if(!i(t.children[e],n.children[e])){return false}}r[n.rest.name]=t.children.slice(1+n.rest.before,t.children.length-n.rest.after);for(let e=0;e<n.rest.after;e++){if(!i(t.children[t.children.length-n.rest.after+e],n.children[e+1+1+n.rest.before])){return false}}}else{for(let e=1;e<n.children.length;e++){if(!i(t.children[e],n.children[e])){return false}}}return true}else{r[n.token.value]=t;return true}}return i(e,t)?r:null}function f(e){const t={type:e.type,token:{type:e.token.type,value:e.token.value}};if(e.type==="list"){t.children=e.children.map(f)}return t}function h(e){return e.length>1&&e[0]==="_"}function d(e,i,o){const u={};function s(t){if(t.children.length>0){const n=t.children[0];if(h(n.token.value)){if(!u[n.token.value]){if(typeof o[n.token.value]!=="undefined"){o[n.token.value]++}else{o[n.token.value]=0}u[n.token.value]=`${n.token.value}_${o[n.token.value]}`}n.token.value=u[n.token.value]}}for(let e=1;e<t.children.length;e++){const n=t.children[e];if(n.token.type==="identifier"){const r=i[n.token.value];if(Array.isArray(r)){t.children.splice(e,1,...r);e+=r.length-1}else if(r){t.children[e]=r}else if(h(n.token.value)){if(!u[n.token.value]){if(typeof o[n.token.value]!=="undefined"){o[n.token.value]++}else{o[n.token.value]=0}u[n.token.value]=n.token.value+"_"+o[n.token.value]}n.token.value=u[n.token.value]}}else if(n.type==="list"){s(n)}}}if(e.token.type==="identifier"){const t=i[e.token.value];if(t){e.token=t.token;if(t.type==="list"){e.children=t.children}}}else if(e.type==="list"){s(e)}}function p(e){return e.length>3&&e.slice(-3)==="..."}function k(e){function r(t){if(t.type!=="list"){return}for(let e=1;e<t.children.length;e++){const{token:n}=t.children[e];if(n.type==="identifier"&&p(n.value)){t.rest={before:e-1,after:t.children.length-e-1,name:n.value}}else{r(t.children[e])}}}r(e)}function r(e,t){const o=new Set;const u=new Set;function s(t){if(t.children.length>0&&t.children[0].token.type!=="identifier"){throw new Error(`Tokens of type ${t.children[0].token.type} are not allowed in patterns`)}let n=false;for(let e=1;e<t.children.length;e++){const r=t.children[e];if(r.token.type==="identifier"){if(h(r.token.value)){throw new Error("Pattern can not contain variables prefixed by '_'")}if(p(r.token.value)){const i=r.token.value.slice(0,-3);if(o.has(i)){throw new Error(`Variable '${i}' already used in pattern`)}else{o.add(i)}if(n){throw new Error("Pattern can contain at most one rest variable on a level")}n=true;u.add(r.token.value)}else{if(o.has(r.token.value)){throw new Error(`Variable '${r.token.value}' already used in pattern`)}else{o.add(r.token.value)}}}else if(r.type==="list"){s(r)}else{throw new Error(`Tokens of type ${r.token.type} are not allowed in patterns`)}}}function n(t){if(t.type==="atom"){if(t.token.type==="identifier"&&p(t.token.value)&&!u.has(t.token.value)){throw new Error(`Rest variable '${t.token.value}' is not present in pattern`)}return}for(let e=0;e<t.children.length;e++){n(t.children[e])}}if(e.type==="list"){s(e)}else{throw new Error("Pattern can not be an atom")}n(t)}function i(e,r,i,o={}){k(r);function u(e){const t=c(e,r);if(t){const n=f(i);d(n,t,o);e.token=n.token;e.children=n.children}if(e.type==="list"){e.children.forEach(u)}}u(e)}export{i as expand,t as parse,n as serialize,e as tokenize,r as validateRule};